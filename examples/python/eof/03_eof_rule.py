# Generated by re2c
# re2py $INPUT -o $OUTPUT

# expect a null-terminated string
def lex(str):
    cur = 0
    lim = len(str) - 1 # terminating null not included
    count = 0

    while True:
    
        yystate = 0
        while True:
            match yystate:
                case 0:
                    yych = str[cur]
                    match yych:
                        case 0x20:
                            cur += 1
                            yystate = 3
                            continue
                        case 0x27:
                            cur += 1
                            yystate = 5
                            continue
                        case _:
                            if cur >= lim:
                                yystate = 10
                                continue
                            cur += 1
                            yystate = 1
                            continue
                case 1:
                    yystate = 2
                    continue
                case 2:
                    return -1
                case 3:
                    yych = str[cur]
                    match yych:
                        case 0x20:
                            cur += 1
                            yystate = 3
                            continue
                        case _:
                            yystate = 4
                            continue
                case 4:
                    break
                case 5:
                    mar = cur
                    yych = str[cur]
                    if yych >= 0x01:
                        yystate = 7
                        continue
                    if cur >= lim:
                        yystate = 2
                        continue
                    cur += 1
                    yystate = 6
                    continue
                case 6:
                    yych = str[cur]
                    yystate = 7
                    continue
                case 7:
                    match yych:
                        case 0x27:
                            cur += 1
                            yystate = 8
                            continue
                        case 0x5C:
                            cur += 1
                            yystate = 9
                            continue
                        case _:
                            if cur >= lim:
                                yystate = 11
                                continue
                            cur += 1
                            yystate = 6
                            continue
                case 8:
                    count += 1
                    break
                case 9:
                    yych = str[cur]
                    if yych <= 0x00:
                        if cur >= lim:
                            yystate = 11
                            continue
                        cur += 1
                        yystate = 6
                        continue
                    cur += 1
                    yystate = 6
                    continue
                case 10:
                    return count
                case 11:
                    cur = mar
                    yystate = 2
                    continue
                case _:
                    raise "internal lexer error"


def test(str, count):
    # termunating null not included in `lim`
    assert count == lex(str)

test(b"\0", 0);
test(b"'qu\0tes' 'are' 'fine: \\'' \0", 3);
test(b"'unterminated\\'\0", -1)
